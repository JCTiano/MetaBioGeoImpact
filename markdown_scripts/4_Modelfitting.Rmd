---
title: "Model fitting script for meta-analysis"
author: "Justin Tiano, Emil De Borger"
date: '2022-10-06'
editor_options: 
  markdown: 
    wrap: 200
output:
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
    extra_dependencies: ["float"]
---

# Summary

In this version rows with SD = 0 are kept, and resulting weights are manually assigned to be able to keep these rows in further analysis.

This script is used to run statistics on the meta-analyis effect size data. First data is loaded and some variables are re-factored (e.g. slicedepth). Focusing on organic carbon measures and chl a as
variables of interest, we first assess the significance of the effects individual predictor variables (factors and continuous) may have on the log response ratios found in different studies. Then, we
determine the best predictive models for the different sets of observations using two methodologies: stepwise model selection and multimodel predictions. Throughout this data exploration the
observations on OC and chl are divided into different subsets: the immediate response (=\< 24 h after disturbance), recovery (all known times) and all available data (contains observations where time
since last disturbance is unknown).

Throughout this document some code is shown, some not, for legibility purposes.

First, wilcoxon tests on all data subsets indicate a statistically significant difference of 
the mean lnRR to 0, with estimates all below 0 (ranging from -0.134 to -0.234). Meaning that, throughout our dataset, the response to trawling is a decrease in TOC and Chl a.

Below, the significant/non-significant predictors are mentioned for each tested subset of data. The full results can be found further below.

OCshort

-   sOC: Significant difference in means for habitat type: lower lnRR in mud.
-   sOCcont: significant variables are current velocity, and surface pp.
-   Best model stepwise: current velocity + habitat type + bottom water oxygen.
-   Best model multimodel: current velocity.

OC recovery

-   rOC: No statistical significant differences in means of factor levels.
-   rOCcont: Significant linear correlation with current velocity, hours fished, surface pp.
-   Best model stepwise: current velocity + slice-depth.
-   Best model multimodel: current velocity.

OC all data

-   aOC: No statistically significant differences in means of factor levels.
-   aOCcont: Significant linear correlation with current velocity, hours fished, water depth, surface pp. 
These predictors (barring hours fished) are also significantly correlated, cannot use all in model fitting.
-   Best model stepwise: current velocity, habitat type, water depth, bottom water O2.
-   Best model multimodel: urrent velocity, habitat type, water depth, bottom water O2, season.

CHshort

-   sCH: Significant difference in means for season: higher lnRR in winter.
-   sCHcont: significant variable is surface pp.
-   Best model stepwise: current velocity + surface pp + hours fished.
-   Best model multimodel: water depth + surface pp + hours fished.

CH recovery

-   rCH: Significant factor effects for slice depth, historically fished, and habitat type.
-   rCHcont: Significant linear correlation with current velocity, surface pp, O2 bottom water, distance to shore.
-   Best model stepwise: slice-depth + water depth + bottom water O2 + surface pp + time since trawling.
-   Best model multimodel: time since trawling (low r2: 8.15%, 2nd best model selected 27%).
-   2nd model multimodel: habitat type + water depth + surface pp + bottom water O2 + distance to shore.

CH all data

-   aCH: Significant factor effects for slice depth and habitat type.
-   aCHcont: Significant linear correlation with current velocity and surface pp. 
-   Best model stepwise: slice-depth + water depth + habitat type + current velocity + water depth + O2 bottom water.
-   Best model multimodel: slice-depth + water depth + habitat type + current velocity + O2 bottom water

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(metafor)
library(glmulti)
source("~/GitHub/Metastudy2/source_code/Plot.functions.R")

# Colors used
mycol  <- rgb(95, 158, 160, max = 255, alpha = 100, names = "Pine Green")
mycol2 <- rgb(95, 158, 160, max = 255, alpha = 25, names = "Pine Green")

# Multimodel fitting function
rma.glmulti <- function(formula, data, ...)
   rma(formula, vi = VarLnRR, weights = W, data=data, method="REML", ...)

```

# Read data / subsetting

## Read and change title

Input functions for plots and calculations - shows edits to the original effect size dataframe (df) which includes combining certain categories, and fixing details for individual studies.

```{r rename columns, results = FALSE}

# load("../r_objects/Exp-Obs.rda")
# get(load("../dataset/dataset.rdata"))
load("../r_objects/Exp-Obs_041122.rda")

# Edit column names for to facilitate modelling.

colnames(df)[colnames(df) == "Response.variable"]                     <- "respvar"
colnames(df)[colnames(df) == "Sample.core.depth.slice"]               <- "slicedepth"
colnames(df)[colnames(df) == "Study.type"]                            <- "stype"
colnames(df)[colnames(df) == "Harmonized_study.type"]                 <- "hstype"
colnames(df)[colnames(df) == "Water.depth..m."]                       <- "watdepth"
colnames(df)[colnames(df) == "Trawling.effort_numerical_harmonized"]  <- "heffortnum"
colnames(df)[colnames(df) == "Trawling_effort_GFW"]                   <- "effortGFW"
colnames(df)[colnames(df) == "Model_Chl_bottom..mg.m3"]               <- "chlabot"
colnames(df)[colnames(df) == "Model_Current_velocity..m.s."]          <- "cvel"
colnames(df)[colnames(df) == "Model_Dissolved_Oxygen..mol.m3."]       <- "O2bot"
colnames(df)[colnames(df) == "Model_NO3_bottom..mol.m3."]             <- "nitbot"
colnames(df)[colnames(df) == "Model_PO4_bottom..mol.m3."]             <- "phosbot"
colnames(df)[colnames(df) == "Model_Sal_bottom"]                      <- "salbot"
colnames(df)[colnames(df) == "Model_Silicate_bottom..mol.m3."]        <- "silbot"
colnames(df)[colnames(df) == "Model_Temp_bottom"]                     <- "tempbot"
colnames(df)[colnames(df) == "Model_NPP_surface..g.m3.day."]          <- "nppsurf"
colnames(df)[colnames(df) == "dist_shore..m."]                        <- "shoredist"
colnames(df)[colnames(df) == "Time.since.trawl..days."]               <- "timesincetrawl"
colnames(df)[colnames(df) == "Time.since.first.disturbance..years."]  <- "timefirstdist"
colnames(df)[colnames(df) == "Habitat.type_harmonized"]               <- "hhabtype"
colnames(df)[colnames(df) == "Seasonality_harmonized"]                <- "hseason"
colnames(df)[colnames(df) == "Trawling.gear.type_harmonized"]         <- "gear"
colnames(df)[colnames(df) == "Historically.fished"]                   <- "histfished"
colnames(df)[colnames(df) == "Trawling.effort_categorical"]           <- "effortcat"
colnames(df)[colnames(df) == "Trawling.effort_units_harmonized"]      <- "heffortunits"
colnames(df)[colnames(df) == "Control_historically_trawled"]          <- "CTRLhisttrawled"

```

## Refactoring slicedepth

```{r refactor slicedepths}

# Refactoring data: combining categories

## Depth slices --> I think there's still something wrong here.
## I'm going with 0-1, 1-2, 2-5, 5-10, 10+ as classes for lowest common denominator.
## For the categories 0-x it is more difficult but al least the number of categories has been
## brought down drastically already.
df$sslicedepth <- df$slicedepth
df$sslicedepth[df$sslicedepth=="0-0.3"]   = "0-1"
df$sslicedepth[df$sslicedepth=="0-0.5"]   = "0-1"
df$sslicedepth[df$sslicedepth=="0-1"]     = "0-1"
df$sslicedepth[df$sslicedepth=="0.5-1"]   = "0-1"
df$sslicedepth[df$sslicedepth=="Surface"] = "0-1"

df$sslicedepth[df$sslicedepth=="1-1.5"] = "1-2"
df$sslicedepth[df$sslicedepth=="1.5-2"] = "1-2"
df$sslicedepth[df$sslicedepth=="1-3"]   = "1-2" #ranks

df$sslicedepth[df$sslicedepth=="2-2.5"] = "2-5"
df$sslicedepth[df$sslicedepth=="2.5-3"] = "2-5"
df$sslicedepth[df$sslicedepth=="2-3"]   = "2-5"
df$sslicedepth[df$sslicedepth=="3-4"]   = "2-5"
df$sslicedepth[df$sslicedepth=="4-5"]   = "2-5"
df$sslicedepth[df$sslicedepth=="3-5"]   = "2-5"
df$sslicedepth[df$sslicedepth=="3-3.5"] = "2-5"
df$sslicedepth[df$sslicedepth=="3.5-4"] = "2-5"
df$sslicedepth[df$sslicedepth=="4-4.5"] = "2-5"
df$sslicedepth[df$sslicedepth=="4.5-5"] = "2-5"
df$sslicedepth[df$sslicedepth=="2-4"]   = "2-5"
df$sslicedepth[df$sslicedepth=="4-6"]   = "2-5"

df$sslicedepth[df$sslicedepth=="5-6"]  = "5-10"
df$sslicedepth[df$sslicedepth=="6-7"]  = "5-10"
df$sslicedepth[df$sslicedepth=="7-8"]  = "5-10"
df$sslicedepth[df$sslicedepth=="8-9"]  = "5-10"
df$sslicedepth[df$sslicedepth=="9-10"] = "5-10"
df$sslicedepth[df$sslicedepth=="5-7"]  = "5-10"
df$sslicedepth[df$sslicedepth=="7-9"]  = "5-10"
df$sslicedepth[df$sslicedepth=="7-10"] = "5-10"
df$sslicedepth[df$sslicedepth=="5-10"] = "5-10"
df$sslicedepth[df$sslicedepth=="4-8"]  = "5-10"
df$sslicedepth[df$sslicedepth=="6-10"] = "5-10"

df$sslicedepth[df$sslicedepth=="10-11"] = "10+"
df$sslicedepth[df$sslicedepth=="11-12"] = "10+"
df$sslicedepth[df$sslicedepth=="12-13"] = "10+"
df$sslicedepth[df$sslicedepth=="13-14"] = "10+"
df$sslicedepth[df$sslicedepth=="14-15"] = "10+"
df$sslicedepth[df$sslicedepth=="15-16"] = "10+"
df$sslicedepth[df$sslicedepth=="16-17"] = "10+"
df$sslicedepth[df$sslicedepth=="17-18"] = "10+"
df$sslicedepth[df$sslicedepth=="18-19"] = "10+"
df$sslicedepth[df$sslicedepth=="19-20"] = "10+"
df$sslicedepth[df$sslicedepth=="20-21"] = "10+"
df$sslicedepth[df$sslicedepth=="21-22"] = "10+"
df$sslicedepth[df$sslicedepth=="22-23"] = "10+"
df$sslicedepth[df$sslicedepth=="23-24"] = "10+"
df$sslicedepth[df$sslicedepth=="24-25"] = "10+"
df$sslicedepth[df$sslicedepth=="25-26"] = "10+"
df$sslicedepth[df$sslicedepth=="26-27"] = "10+"
df$sslicedepth[df$sslicedepth=="27-28"] = "10+"
df$sslicedepth[df$sslicedepth=="28-29"] = "10+"
df$sslicedepth[df$sslicedepth=="29-30"] = "10+"
df$sslicedepth[df$sslicedepth=="30-31"] = "10+"
df$sslicedepth[df$sslicedepth=="31-32"] = "10+"
df$sslicedepth[df$sslicedepth=="32-33"] = "10+"
df$sslicedepth[df$sslicedepth=="33-34"] = "10+"
df$sslicedepth[df$sslicedepth=="34-35"] = "10+"
df$sslicedepth[df$sslicedepth=="35-36"] = "10+"
df$sslicedepth[df$sslicedepth=="36-37"] = "10+"
df$sslicedepth[df$sslicedepth=="37-38"] = "10+"
df$sslicedepth[df$sslicedepth=="38-39"] = "10+"
df$sslicedepth[df$sslicedepth=="39-40"] = "10+"
df$sslicedepth[df$sslicedepth=="40-41"] = "10+"
df$sslicedepth[df$sslicedepth=="41-42"] = "10+"
df$sslicedepth[df$sslicedepth=="42-43"] = "10+"
df$sslicedepth[df$sslicedepth=="10-12"] = "10+"
df$sslicedepth[df$sslicedepth=="10-15"] = "10+"
df$sslicedepth[df$sslicedepth=="15-20"] = "10+"

df$sslicedepth[df$sslicedepth=="Grab sample"] = "0-5"
df$sslicedepth[df$sslicedepth=="Full core"]   = "0-5"

```

## Subsetting

We subset the dataset:

-   short: immediate trawling impact measurements: =< 1 day impact assessment.
-   recovery: trawling + recovery for all known trawling times.
-   All: all samples
-   UN: unknown sampling time since trawl ==> Not used in the end.

The logic of subsetting is to facilitate making regressions with different known times.

-   Short term is considered as assessed within 1 day of disturbing.
-   Recovery is a more long-term assessment.
-   all is all data, and in this dataset we do not focus on recovery time.

```{r subset dataframes to work with, echo = FALSE}

df$timesincetrawl <- as.numeric(df$timesincetrawl)
df[, 87] <- factor(df[, 87], levels = c("0-1", "1-2", "2-5", "5-10", "10+", "0-2", "0-2.5", "0-3", "0-4", "0-5", "0-5.5", "0-10", "in-situ incubations", "on-board incubations", "surface sediment"))
df[, 14] <- as.factor(df[, 14])
df[, 35] <- as.factor(df[, 35])
df[, 36] <- as.factor(df[, 36])
df[, 37] <- as.factor(df[, 37])
df[, 38] <- as.factor(df[, 38])

# Datasets for short and long term trawling effects
## Shortterm only ( = < 1 day or 24 hours recovery)
short = subset(df, df$timesincetrawl <= 1 & df$timesincetrawl >= 0 ) # select immediate trawling

## All known times 
rec = subset(df , !is.na(df$timesincetrawl))        # first take out unknown for recovery models
rec = subset(rec, rec$timesincetrawl >= 0)          # trawling + recovery for all known trawling times
rec$timesincetrawl = as.numeric(rec$timesincetrawl) 

## All and unknown subsets
all = df                                              # Comprehensive dataset
unk = subset(df, is.na(df$timesincetrawl))            # Dataset where time since last trawled is not known

# Datasets for TOC and Chl-a used in meta-regressions 
## For OC
OCshort = subset(short, respvar == "TOC")
OCrec   = subset(rec  , respvar == "TOC")
OCall   = subset(all  , respvar == "TOC")
OCunk   = subset(unk  , respvar == "TOC")

## For chl a
CHshort = subset(short, respvar == "Chl-a")
CHrec   = subset(rec  , respvar == "Chl-a")
CHall   = subset(all  , respvar == "Chl-a")
CHunk   = subset(unk  , respvar == "Chl-a")

# details = df[,c(1:6,8:12,28)] # to view dataframe with details for all observations

save(OCshort, OCrec, OCall, OCunk, 
     CHshort, CHrec, CHall, CHunk, 
     df, short, rec, all, unk, file = "../r_objects/meta.datnov2022.rda")

```

Retrieve data (to skip above steps)

```{r, warning=FALSE, echo = FALSE}

load("../r_objects/meta.datnov2022.rda")

```

## Summary statistics 

```{r summarystats, options}

a <- wilcox.test(OCshort$lnRR, mu = 0, conf.int = TRUE)
b <- wilcox.test(OCrec$lnRR, mu = 0, conf.int = TRUE)
c <- wilcox.test(OCall$lnRR, mu = 0, conf.int = TRUE)

d <- wilcox.test(CHshort$lnRR, mu = 0, conf.int = TRUE)
e <- wilcox.test(CHrec$lnRR, mu = 0, conf.int = TRUE)
f <- wilcox.test(CHall$lnRR, mu = 0, conf.int = TRUE)

wttable <- data.frame("difference means" = c(a$estimate,b$estimate, c$estimate, d$estimate, e$estimate, f$estimate),
                      "pvalue" = c(a$p.value, b$p.value, c$p.value, d$p.value, e$p.value, f$p.value))

row.names(wttable) <- c("OC-short", "OC-recovery", "OC-all",
                        "CH-short", "CH-recovery", "CH-all")

knitr::kable(wttable, caption = "Results Wilcox test")

```

Note on use of rma.uni with the full dataset:

-   Restricted maximum likelihood estimator (REML) is used as it is apparently the most robust estimator for our type of data, and it can deal with our instances where VarLnRR = 0.
    -   However it gives a warning, and it cannot perform the QE test or compute I\^2 and H\^2.
-   We stick to a weighted analysis, given previous steps taken to ensure a weight is available.
    -   This is the default so no need to specify, however I provide the weights because otherwise they are calculated again without the corrections in 2_EF_calculation.

Factors: - Habitat type - Historically fished - Season - Slice depth

Continuous - Water depth - Fishing effort (h) - Current velocity - Salinity bottom - Oxygen bottom - Time since trawling

Fitted models overview

# SHORT TERM OC

## Individual variables

```{r OC short term factors, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 8}

sOCdept <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~sslicedepth)
sOChist <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~histfished)
sOChsea <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~hseason)
sOChabi <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~hhabtype)

sOC <- data.frame("Mods"     = c("Slice depth", "Historically fished", "Season", "Sediment"),
                  "Rsquared" = c(sOCdept$R2, sOChist$R2, sOChsea$R2, sOChabi$R2),
                  "Pvalue"   = c(sOCdept$QMp, sOChist$QMp, sOChsea$QMp, sOChabi$QMp))

knitr::kable(sOC)

bplot(df = OCshort, var = "sslicedepth", mtitle = "Slice depth", cex.axis = 0.6)
bplot(df = OCshort, var = "histfished" , mtitle = "Historically fished")
bplot(df = OCshort, var = "hseason"    , mtitle = "Season")
bplot(df = OCshort, var = "hhabtype"   , mtitle = "Habitat type")

```

## Continuous variables

```{r OC short term continuous, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 6}

sOCvel      <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~cvel, slab = article_id)
sOCfisheff  <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~heffortnum)
sOCdepth    <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~watdepth)
logsOCdepth <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~log(watdepth))
sOCnpp      <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~nppsurf)
sOCoxy      <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~O2bot)
sOCdist     <- rma.uni(data = OCshort, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~shoredist)

sOCcont <- data.frame("Mods" = c("Current velocity", "Hours fished", "Depth", "NPP surf.", "O2 bottom", "Dist. shore"),
             "Rsquared" = c(sOCvel$R2, sOCfisheff$R2, sOCdepth$R2, sOCnpp$R2, sOCoxy$R2, sOCdist$R2),
             "Pvalue"   = c(sOCvel$QMp, sOCfisheff$QMp, sOCdepth$QMp, sOCnpp$QMp, sOCoxy$QMp, sOCdist$QMp))

knitr::kable(sOCcont)

cplot(m = sOCvel     , scol = mycol2, bgcol = mycol, xlabz = "m/s", mtitle = "Current velocity")
cplot(m = sOCfisheff , scol = mycol2, bgcol = mycol, xlabz = "hours fished", mtitle = "Fishing effort")
cplot(m = sOCdepth   , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth")
cplot(m = logsOCdepth, scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth (log)")
cplot(m = sOCnpp     , scol = mycol2, bgcol = mycol, xlabz = "pp units", mtitle = "Primary productivity")
cplot(m = sOCoxy     , scol = mycol2, bgcol = mycol, xlabz = "mmol O2 /m3", mtitle = "Bottom water oxygen")
cplot(m = sOCdist    , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Distance to shore")

```

## Full model selection

--\> Cannot use heffortnum, too many datapoints missing and very biased.

OCshort[, c(20, 21, 24, 25, 31, 32)]

### Stepwise

```{r stepwise selection OC short, echo = FALSE, warning = FALSE}

OCshortx <- OCshort[-c(74:83), ]

mod1 <- rma.uni(data = OCshortx, yi = lnRR, vi = VarLnRR, weights = W, 
                method = "REML", slab = article_id, 
               mods = ~sslicedepth + histfished + hseason + hhabtype +
                 cvel + watdepth + nppsurf + O2bot + timesincetrawl)

# Removing least significant parameter.
mod2 <- update(mod1, ~. -nppsurf)
mod3 <- update(mod2, ~. -histfished)
mod4 <- update(mod3, ~. -watdepth)
mod5 <- update(mod4, ~. -hseason)    # Final model    
mod6 <- update(mod5, ~. -timesincetrawl) # remove for multicollinearity
mod7 <- update(mod6, ~. -sslicedepth)

modOCshort <- rma.uni(data = OCshortx, yi = lnRR, vi = VarLnRR, weights = W, 
                      method = "REML", slab = article_id, mods = ~ cvel + 
                      hhabtype + O2bot)

rm(mod1, mod2, mod3, mod4, mod5, mod6, mod7)

summary(modOCshort)

```

### Multimodel

```{r multimodel selection OC short, echo = FALSE, warning = FALSE}

modOCshortmulti <- glmulti(lnRR ~ sslicedepth + histfished + hseason + hhabtype +
                   cvel + watdepth + nppsurf + O2bot + timesincetrawl + heffortnum +
                   cvel*watdepth, 
                   data= OCshortx, plotty = FALSE, report = FALSE, 
                   level=1, fitfunction=rma.glmulti, crit="aicc", confsetsize=1024)

topOCshortmulti <- weightable(modOCshortmulti)

knitr::kable(topOCshortmulti[1:10,], caption = "OC short top 10 models")

modOCshort2 <- rma.uni(data = OCshortx, yi = lnRR, vi = VarLnRR, weights = W, 
                      method = "REML", slab = article_id, mods = ~ cvel)

summary(modOCshort2)

```

# RECOVERY OC

## Individual variables

```{r OC recovery factors, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 8}

rOCdept <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~sslicedepth)
rOChist <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~histfished)
rOChsea <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~hseason)
rOChabi <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~hhabtype)

rOC <- data.frame("Mods"     = c("Slice depth", "Historically fished", "Season", "Sediment"),
                  "Rsquared" = c(rOCdept$R2, rOChist$R2, rOChsea$R2, rOChabi$R2),
                  "Pvalue"   = c(rOCdept$QMp, rOChist$QMp, rOChsea$QMp, rOChabi$QMp))

knitr::kable(rOC)

bplot(df = OCrec, var = "sslicedepth", mtitle = "Slice depth")
bplot(df = OCrec, var = "histfished" , mtitle = "Historically fished")
bplot(df = OCrec, var = "hseason"    , mtitle = "Season")
bplot(df = OCrec, var = "hhabtype"   , mtitle = "Habitat type")

```

## Continuous variables

```{r OC recovery term continuous, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 6}

rOCvel      <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~cvel)
rOCfisheff  <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~heffortnum)
rOCdepth    <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~watdepth)
rOCnpp      <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~nppsurf)
rOCoxy      <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~O2bot)
rOCdist     <- rma.uni(data = OCrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~shoredist)

rOCcont <- data.frame("Mods" = c("Current velocity", "Hours fished", "Depth", "NPP surf.", "O2 bottom", "Dist. shore"),
             "Rsquared" = c(rOCvel$R2, rOCfisheff$R2, rOCdepth$R2, rOCnpp$R2, rOCoxy$R2, rOCdist$R2),
             "Pvalue"   = c(rOCvel$QMp, rOCfisheff$QMp, rOCdepth$QMp, rOCnpp$QMp, rOCoxy$QMp, rOCdist$QMp))

knitr::kable(rOCcont)

cplot(m = rOCvel     , scol = mycol2, bgcol = mycol, xlabz = "m/s", mtitle = "Current velocity")
cplot(m = rOCfisheff , scol = mycol2, bgcol = mycol, xlabz = "hours fished", mtitle = "Fishing effort")
cplot(m = rOCdepth   , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth")
#cplot(m = logsOCdepth, scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth (log)")
cplot(m = rOCnpp     , scol = mycol2, bgcol = mycol, xlabz = "pp units", mtitle = "Primary productivity")
cplot(m = rOCoxy     , scol = mycol2, bgcol = mycol, xlabz = "mmol O2 /m3", mtitle = "Bottom water oxygen")
cplot(m = rOCdist    , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Distance to shore")

```

## Full model selection

### Stepwise

OCrec[, c(8, 20, 21, 24, 25, 31, 32, 35, 36, 87)]

```{r stepwise selection OC recovery, warning = FALSE, echo = FALSE}

OCrecx <- OCrec[-c(89, 90, 106:115), ]

mod1 <- rma.uni(data = OCrecx, yi = lnRR, vi = VarLnRR, weights = W, 
                method = "REML", slab = article_id, 
               mods = ~sslicedepth + histfished + hseason + hhabtype +
                 cvel + watdepth + nppsurf + O2bot + heffortnum + log(timesincetrawl+1))

mod2 <- update(mod1, ~. -O2bot)
mod3 <- update(mod2, ~. -histfished)
mod4 <- update(mod3, ~. -nppsurf)
mod5 <- update(mod4, ~. -hhabtype)
mod6 <- update(mod5, ~. -heffortnum)
mod7 <- update(mod6, ~. -hseason)
mod8 <- update(mod7, ~. -watdepth)
mod9 <- update(mod8, ~. -log(timesincetrawl+1)) # Final model

modOCrec <- rma.uni(data = OCrecx, yi = lnRR, vi = VarLnRR, weights = W, 
                      method = "REML", slab = article_id, mods = ~ cvel + sslicedepth)

rm(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9)

summary(modOCrec)

```

### Multimodel

```{r multimodel selection OC recovery, warning = FALSE, echo = FALSE}

modOCrecmulti <- glmulti(lnRR ~ sslicedepth + histfished + hseason + hhabtype +
                 cvel + watdepth + nppsurf + O2bot + heffortnum + log(timesincetrawl+1),
                 data = OCrecx, plotty = FALSE, repovrt = FALSE, 
                 level = 1, fitfunction = rma.glmulti, crit = "aicc", confsetsize = 1024)

topOCrecmulti <- weightable(modOCrecmulti)

knitr::kable(topOCrecmulti[1:10,], caption = "OC short top 10 models")

modOCrec2 <- rma.uni(data = OCrecx, yi = lnRR, vi = VarLnRR, weights = W, 
                      method = "REML", slab = article_id, mods = ~ cvel)

summary(modOCrec2)

```

# ALL DATA OC

## Individual variables

```{r OC all data factors, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 8}

aOCdept <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(sslicedepth))
aOChist <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(histfished))
aOChsea <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(hseason))
aOChabi <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(hhabtype))

aOC <- data.frame("Mods"     = c("Slice depth", "Historically fished", "Season", "Sediment"),
                  "Rsquared" = c(aOCdept$R2, aOChist$R2, aOChsea$R2, aOChabi$R2),
                  "Pvalue"   = c(aOCdept$QMp, aOChist$QMp, aOChsea$QMp, aOChabi$QMp))

knitr::kable(aOC)

bplot(df = OCall, var = "sslicedepth", mtitle = "Slice depth")
bplot(df = OCall, var = "histfished" , mtitle = "Historically fished")
bplot(df = OCall, var = "hseason"    , mtitle = "Season")
bplot(df = OCall, var = "hhabtype"   , mtitle = "Habitat type")

```

## Continuous variables

```{r OC alldata continuous, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 6}

aOCvel      <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~cvel)
aOCfisheff  <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~heffortnum)
aOCdepth    <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~watdepth)
aOCnpp      <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~nppsurf)
aOCoxy      <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~O2bot)
aOCdist     <- rma.uni(data = OCall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~shoredist)

aOCcont <- data.frame("Mods" = c("Current velocity", "Hours fished", "Depth", "NPP surf.", "O2 bottom", "Dist. shore"),
             "Rsquared" = c(aOCvel$R2, aOCfisheff$R2, aOCdepth$R2, aOCnpp$R2, aOCoxy$R2, aOCdist$R2),
             "Pvalue"   = c(aOCvel$QMp, aOCfisheff$QMp, aOCdepth$QMp, aOCnpp$QMp, aOCoxy$QMp, aOCdist$QMp))

knitr::kable(aOCcont)

cplot(m = aOCvel     , scol = mycol2, bgcol = mycol, xlabz = "m/s", mtitle = "Current velocity")
cplot(m = aOCfisheff , scol = mycol2, bgcol = mycol, xlabz = "hours fished", mtitle = "Fishing effort")
cplot(m = aOCdepth   , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth")
cplot(m = aOCnpp     , scol = mycol2, bgcol = mycol, xlabz = "pp units", mtitle = "Primary productivity")
cplot(m = aOCoxy     , scol = mycol2, bgcol = mycol, xlabz = "mmol O2 /m3", mtitle = "Bottom water oxygen")
cplot(m = aOCdist    , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Distance to shore")

cor(na.omit(OCall[,c("cvel", "watdepth", "nppsurf")]))

```

## Full model selection

### Stepwise

-   Not using heffortnum here because there is too much missing data.
-   Not using timessincetrawl.
-   Not using 167, 111, 185.
-   Note, "yearly" as season is a bit strange.
-   OCall[, c(8, 20, 21, 24, 25, 31, 32, 35, 36, 87)]

```{r stepsel OC alldata, warning = FALSE, echo = FALSE}

OCallx <- OCall[-c(194, 211:222, 247:256), ]

mod1 <- rma.uni(data = OCallx, yi = lnRR, vi = VarLnRR, weights = W, 
                method = "REML", slab = article_id, 
                mods = ~sslicedepth + histfished + hseason + hhabtype +
                        cvel + watdepth + nppsurf + O2bot)

# Removing least significant parameter.
mod2 <- update(mod1, ~. -sslicedepth) # Large decrease AIC.
mod3 <- update(mod2, ~. -histfished)
mod4 <- update(mod3, ~. -hseason)    # Best model based on AIC/no further pars to remove.
mod5 <- update(mod4, ~. -nppsurf)    # remove for multicollinearity

modOCall <- rma.uni(data = OCallx, yi = lnRR, vi = VarLnRR, weights = W, 
                      method = "REML", slab = article_id, mods = ~ cvel + hhabtype + watdepth + O2bot)

rm(mod1, mod2, mod3, mod4, mod5)

summary(modOCall)
#plot(modOCall)

```

### Multimodel

```{r, multisel OC alldata, warning = FALSE, echo = FALSE}

modOCallmulti <- glmulti(lnRR ~ sslicedepth + histfished + hseason + hhabtype +
                 cvel + watdepth + nppsurf + O2bot + shoredist,
                 data = OCallx, plotty = FALSE, report = FALSE, 
                 level = 1, fitfunction = rma.glmulti, crit = "aicc", confsetsize = 512)

topOCallmulti <- weightable(modOCallmulti)

knitr::kable(topOCallmulti[1:10,], caption = "OC short top 10 models")

# Best model selected by multimodel includes nppsurf, but this has multicollinearity issues.
modOCall2 <- rma.uni(data = OCallx, yi = lnRR, vi = VarLnRR, weights = W, 
                     method = "REML", slab = article_id,
                     mods = ~  hseason + hhabtype + cvel + watdepth  + O2bot)

summary(modOCall2)

```

# SHORT TERM CHL A

## Individual variables

-   One observation with VarLnRR > 8 is removed or it does not work with ~sslicedepth.

```{r CHL A short term factors, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 8}

CHshort$sslicedepth <- droplevels(CHshort$sslicedepth, c("0-2.5", "0-3", "0-4", "0-5", "0-5.5", "in-situ incubations", "on-board incubations", "surface sediment"))
CHshortx <- CHshort[-37,]

sCHdept <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~sslicedepth)
sCHhist <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~histfished)
sCHhsea <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~hseason)
sCHhabi <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~hhabtype)

sCH <- data.frame("Mods"     = c("Slice depth", "Historically fished", "Season", "Sediment"),
                  "Rsquared" = c(sCHdept$R2, sCHhist$R2, sCHhsea$R2, sCHhabi$R2),
                  "Pvalue"   = c(sCHdept$QMp, sCHhist$QMp, sCHhsea$QMp, sCHhabi$QMp))

knitr::kable(sCH)

bplot(df = CHshortx, var = "sslicedepth", mtitle = "Slice depth")
bplot(df = CHshortx, var = "histfished" , mtitle = "Historically fished")
bplot(df = CHshortx, var = "hseason"    , mtitle = "Season")
bplot(df = CHshortx, var = "hhabtype"   , mtitle = "Habitat type")

```

## Continuous variables

```{r Chl a short term continuous, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 6}

sCHvel      <- rma.uni(data = CHshortx, yi = lnRR    , vi = VarLnRR, weights = W, method = "REML", mods = ~(cvel))
sCHfisheff  <- rma.uni(data = CHshortx, yi = lnRR    , vi = VarLnRR, weights = W, method = "REML", mods = ~heffortnum)
sCHdepth    <- rma.uni(data = CHshortx, yi = lnRR    , vi = VarLnRR, weights = W, method = "REML", mods = ~watdepth)
sCHnpp      <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~nppsurf)
logsCHnpp   <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~log(nppsurf))
sCHoxy      <- rma.uni(data = CHshortx, yi = lnRR    , vi = VarLnRR, weights = W, method = "REML", mods = ~O2bot)
sCHdist     <- rma.uni(data = CHshortx, yi = lnRR    , vi = VarLnRR, weights = W, method = "REML", mods = ~shoredist)
sCHtst      <- rma.uni(data = CHshortx, yi = lnRR    , vi = VarLnRR, weights = W, method = "REML", mods = ~timesincetrawl)

sCHcont <- data.frame("Mods" = c("Current velocity", "Hours fished", "Depth", "NPP surf.", "O2 bottom", "Dist. shore"),
                      "Rsquared" = c(sCHvel$R2, sCHfisheff$R2, sCHdepth$R2, sCHnpp$R2, sCHoxy$R2, sCHdist$R2),
                      "Pvalue"   = c(sCHvel$QMp, sCHfisheff$QMp, sCHdepth$QMp, sCHnpp$QMp, sCHoxy$QMp, sCHdist$QMp))

knitr::kable(sCHcont)

cplot(m = sCHvel     , scol = mycol2, bgcol = mycol, xlabz = "m/s", mtitle = "Current velocity", updown = 22)
cplot(m = sCHfisheff , scol = mycol2, bgcol = mycol, xlabz = "hours fished", mtitle = "Fishing effort", updown = 22)
cplot(m = sCHdepth   , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth", updown = 22)
cplot(m = sCHnpp     , scol = mycol2, bgcol = mycol, xlabz = "pp units", mtitle = "Primary productivity", updown = 22)
cplot(m = logsCHnpp  , scol = mycol2, bgcol = mycol, xlabz = "pp units", mtitle = "Primary productivity (log)", updown = 22)
cplot(m = sCHoxy     , scol = mycol2, bgcol = mycol, xlabz = "mmol O2 /m3", mtitle = "Bottom water oxygen", updown = 22)
cplot(m = sCHdist    , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Distance to shore", updown = 22)
cplot(m = sCHtst     , scol = mycol2, bgcol = mycol, xlabz = "d", mtitle = "Time since trawling", updown = 22)

```

## Full model selection

### Stepwise

--\> Redo with heffortnum

CHshort[, c(8, 20, 21, 24, 25, 31, 32, 35, 36, 87)]

```{r stepwise selection CH short term, warning = FALSE, echo = FALSE}

CHshortx <- CHshort[-c(37, 57:70), ] # last 14

mod1 <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, 
                method = "REML", slab = article_id, 
                mods = ~sslicedepth + #hseason + hhabtype + histfished +
                cvel + watdepth + nppsurf + O2bot + timesincetrawl +
                heffortnum)

# Removing least significant parameter.
mod2 <- update(mod1, ~. -watdepth)
mod3 <- update(mod2, ~. -sslicedepth)
mod4 <- update(mod3, ~. -O2bot)      # Best model
mod5 <- update(mod4, ~. -timesincetrawl) # Increase AIC but significant predictor.

modCHshort <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, 
                      method = "REML", slab = article_id, mods = ~ cvel + nppsurf + heffortnum)

rm(mod1, mod2, mod3, mod4, mod5)

summary(modCHshort)

# mtest <- rma(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W)
# funnel(mtest, level=c(90, 95, 99), shade=c("white", "gray55", "gray75"), digits=3L, ylim=c(0,.8), legend=TRUE)

```

### Multimodel

```{r multimodel selection CH short term, warning = FALSE, echo = FALSE}

modCHshortmulti <- glmulti(lnRR ~ sslicedepth + histfished + hseason + hhabtype +
                   cvel + watdepth + nppsurf + O2bot + shoredist + heffortnum + timesincetrawl,
                   data = CHshortx, plotty = FALSE, report = FALSE, 
                   level = 1, fitfunction = rma.glmulti, crit = "aicc", confsetsize = 1024)

topCHshortmulti <- weightable(modCHshortmulti)

knitr::kable(topCHshortmulti[1:10,], caption = "OC short top 10 models")

modCHshort2 <- rma.uni(data = CHshortx, yi = lnRR, vi = VarLnRR, weights = W, 
                     method = "REML", slab = article_id,
                     mods = ~   watdepth + nppsurf + heffortnum)

summary(modCHshort2)

```

# RECOVERY CHL A

## Individual variables

```{r CHL A recovery factors, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 8}

rCHdept <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(sslicedepth))
rCHhist <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(histfished))
rCHhsea <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(hseason))
rCHhabi <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(hhabtype))

rCH <- data.frame("Mods"     = c("Slice depth", "Historically fished", "Season", "Sediment"),
                  "Rsquared" = c(rCHdept$R2, rCHhist$R2, rCHhsea$R2, rCHhabi$R2),
                  "Pvalue"   = c(rCHdept$QMp, rCHhist$QMp, rCHhsea$QMp, rCHhabi$QMp))

knitr::kable(rCH)

bplot(df = CHrec, var = "sslicedepth", mtitle = "Slice depth")
bplot(df = CHrec, var = "histfished" , mtitle = "Historically fished")
bplot(df = CHrec, var = "hseason"    , mtitle = "Season")
bplot(df = CHrec, var = "hhabtype"   , mtitle = "Habitat type")

```

## Continuous variables

```{r Chl a recovery continuous, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 6}

rCHvel      <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(cvel))
rCHfisheff  <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~heffortnum)
rCHdepth    <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~watdepth)
rCHnpp      <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~nppsurf)
rCHoxy      <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~O2bot)
rCHdist     <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~shoredist)
rCHtst      <- rma.uni(data = CHrec, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~timesincetrawl)

rCHcont <- data.frame("Mods" = c("Current velocity", "Hours fished", "Depth", "NPP surf.", "O2 bottom", "Dist. shore"),
                      "Rsquared" = c(rCHvel$R2, rCHfisheff$R2, rCHdepth$R2, rCHnpp$R2, rCHoxy$R2, rCHdist$R2),
                      "Pvalue"   = c(rCHvel$QMp, rCHfisheff$QMp, rCHdepth$QMp, rCHnpp$QMp, rCHoxy$QMp, rCHdist$QMp))

knitr::kable(rCHcont)

cplot(m = rCHvel     , scol = mycol2, bgcol = mycol, xlabz = "m/s", mtitle = "Current velocity")
cplot(m = rCHfisheff , scol = mycol2, bgcol = mycol, xlabz = "hours fished", mtitle = "Fishing effort", updown = 22)
cplot(m = rCHdepth   , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth")
cplot(m = rCHnpp     , scol = mycol2, bgcol = mycol, xlabz = "pp units", mtitle = "Primary productivity", updown = 22)
cplot(m = rCHoxy     , scol = mycol2, bgcol = mycol, xlabz = "mmol O2 /m3", mtitle = "Bottom water oxygen")
cplot(m = rCHdist    , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Distance to shore", updown = 22)
cplot(m = rCHtst     , scol = mycol2, bgcol = mycol, xlabz = "d", mtitle = "time since trawl", updown = 22)

```

## Full model selection

### Stepwise

-   Cannot use heffortnum

```{r stepwise selection CH recovery, warning = FALSE, echo = FALSE}

CHrecx <- CHrec[-c(124:137),] # last 14

mod1 <- rma.uni(data = CHrecx, yi = lnRR, vi = VarLnRR, weights = W, 
                method = "REML", slab = article_id, 
                mods = ~sslicedepth + histfished + hseason + hhabtype +
                cvel + watdepth + nppsurf + O2bot + timesincetrawl)

# Removing least significant parameter.
mod2 <- update(mod1, ~. -hhabtype)
mod3 <- update(mod2, ~. -histfished)
mod4 <- update(mod3, ~. -cvel)
mod5 <- update(mod4, ~. -hseason) # no more can be removed based on anova.
mod6 <- update(mod5, ~. -O2bot) # no more can be removed based on anova.

modCHrec <- rma.uni(data = CHrecx, yi = lnRR, vi = VarLnRR, weights = W, 
                    method = "REML", slab = article_id, mods = ~ sslicedepth +
                    watdepth + O2bot + nppsurf + timesincetrawl)

rm(mod1, mod2, mod3, mod4, mod5, mod6)

summary(modCHrec)
# 
# plot(modCHrec)
# 
# mtest <- rma(data = CHallx, yi = lnRR, vi = VarLnRR, weights = W)
# funnel(mtest, level=c(90, 95, 99), shade=c("white", "gray55", "gray75"), digits=3L, ylim=c(0,.8), legend=TRUE)

```

### Multimodel

```{r, multimodel selection CH srecovery, warning = FALSE, echo = FALSE}

modCHrecmulti <- glmulti(lnRR ~ sslicedepth + histfished + hseason + hhabtype +
                         cvel + watdepth + nppsurf + O2bot + shoredist + timesincetrawl,
                         data = CHrecx, plotty = FALSE, report = FALSE, 
                         level = 1, fitfunction = rma.glmulti, crit = "aicc", confsetsize = 1024)

topCHrecmulti <- weightable(modCHrecmulti)

knitr::kable(topCHrecmulti[1:10,], caption = "OC short top 10 models")

modCHrec2 <- rma.uni(data = CHrecx, yi = lnRR, vi = VarLnRR, weights = W, 
                     method = "REML", slab = article_id,
                     mods = ~  timesincetrawl)

summary(modCHrec2)

```

# ALL DATA CHL A

## Individual variables

```{r CHL A all data factors, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 8}

aCHdept <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(sslicedepth))
aCHhist <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(histfished))
aCHhsea <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(hseason))
aCHhabi <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~(hhabtype))

aCH <- data.frame("Mods"     = c("Slice depth", "Historically fished", "Season", "Sediment"),
                  "Rsquared" = c(aCHdept$R2, aCHhist$R2, aCHhsea$R2, aCHhabi$R2),
                  "Pvalue"   = c(aCHdept$QMp, aCHhist$QMp, aCHhsea$QMp, aCHhabi$QMp))

knitr::kable(aCH)

bplot(df = CHall, var = "sslicedepth", mtitle = "Slice depth")
bplot(df = CHall, var = "histfished" , mtitle = "Historically fished")
bplot(df = CHall, var = "hseason"    , mtitle = "Season")
bplot(df = CHall, var = "hhabtype"   , mtitle = "Habitat type")

```

## Continuous variables

```{r Chl a all data continuous, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 6}

aCHvel      <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~cvel)
aCHfisheff  <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~heffortnum)
aCHdepth    <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~watdepth)
aCHnpp      <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~nppsurf)
aCHoxy      <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~O2bot)
aCHdist     <- rma.uni(data = CHall, yi = lnRR, vi = VarLnRR, weights = W, method = "REML", mods = ~shoredist)

aCHcont <- data.frame("Mods" = c("Current velocity", "Hours fished", "Depth", "NPP surf.", "O2 bottom", "Dist. shore"),
                      "Rsquared" = c(aCHvel$R2, aCHfisheff$R2, aCHdepth$R2, aCHnpp$R2, aCHoxy$R2, aCHdist$R2),
                      "Pvalue"   = c(aCHvel$QMp, aCHfisheff$QMp, aCHdepth$QMp, aCHnpp$QMp, aCHoxy$QMp, aCHdist$QMp))

knitr::kable(aCHcont)

cplot(m = aCHvel     , scol = mycol2, bgcol = mycol, xlabz = "m/s", mtitle = "Current velocity")
cplot(m = aCHfisheff , scol = mycol2, bgcol = mycol, xlabz = "hours fished", mtitle = "Fishing effort", updown = 22)
cplot(m = aCHdepth   , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Water depth")
cplot(m = aCHnpp     , scol = mycol2, bgcol = mycol, xlabz = "pp units", mtitle = "Primary productivity", updown = 22)
cplot(m = aCHoxy     , scol = mycol2, bgcol = mycol, xlabz = "mmol O2 /m3", mtitle = "Bottom water oxygen")
cplot(m = aCHdist    , scol = mycol2, bgcol = mycol, xlabz = "m", mtitle = "Distance to shore", updown = 22)

```

## Full model selection

### Stepwise

-   Cannot use heffortnum

CHall[, c(8, 20, 21, 24, 25, 31, 32, 35, 36, 87)]

```{r stepwise selection CH all data, warning = FALSE, echo = FALSE}

CHallx <- CHall[-c(79:86, 138:151), ] # last 14

mod1 <- rma.uni(data = CHallx, yi = lnRR, vi = VarLnRR, weights = W, 
                method = "REML", slab = article_id, 
                mods = ~sslicedepth + histfished + hseason + hhabtype +
                cvel + watdepth + nppsurf + O2bot)

mod2 <- update(mod1, ~. -hseason)    # AIC 
mod3 <- update(mod2, ~. -histfished) # AIC
mod4 <- update(mod3, ~. -nppsurf)    # Final model


modCHall <- rma.uni(data = CHallx, yi = lnRR, vi = VarLnRR, weights = W, 
                    method = "REML", slab = article_id, mods = ~ sslicedepth 
                    + watdepth + hhabtype + cvel + watdepth + O2bot)

rm(mod1, mod2, mod3, mod4)

summary(modCHall)
# plot(modCHall)

```

### Multimodel

```{r, multivariate selection CH all data, warning = FALSE, echo = FALSE}

modCHallmulti <- glmulti(lnRR ~ sslicedepth + histfished + hseason + hhabtype +
                         cvel + watdepth + nppsurf + O2bot + shoredist,
                         data = CHallx, plotty = FALSE, report = FALSE, 
                         level = 1, fitfunction = rma.glmulti, crit = "aicc", confsetsize = 512)

topCHallmulti <- weightable(modCHallmulti)

knitr::kable(topCHallmulti[1:10,], caption = "OC short top 10 models")

modCHall2 <- rma.uni(data = CHallx, yi = lnRR, vi = VarLnRR, weights = W, 
                     method = "REML", slab = article_id,
                     mods = ~  sslicedepth + hhabtype + cvel + watdepth + O2bot)

summary(modCHall2)

```

