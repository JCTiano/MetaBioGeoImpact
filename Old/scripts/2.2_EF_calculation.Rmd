---
title: "Effect size calculation for meta-analysis"
author: "Justin Tiano"
date: "01/08/2022"
output:
  html_document:
    toc: true
    toc_float: true
---

# Introduction 

This script organizes the meta-analysis data to calculate 3 types of treatment effect sizes:
  1. Log response ratios (lnRR),
  2. Standardized mean difference (Cohen's d), and 
  3. Standardized mean difference (Hedges g). 
The resulting dataframe is saved as "Exp-Obs.rda".

In this version rows with sd = 0 are eventually removed.

```{r loading required packages, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

# Read data

```{r read dataset}

df <- get(load("../dataset/dataset.rdata"))

```

# Organize columns to calculate lnRR

- BA - Studies   --> response1 = before , response 2 = after.
- CI - Studies   --> response1 = control, response 2 = impact.
- BACI - Studies --> response1 = ratio after/before control, response 2 = ratio after/before impact.

```{r assign response and sds}

### Before After studies
df$response1[df$Study.type == "Before After"] = df$Mean_Before_impact[df$Study.type == "Before After"]
df$SD1[df$Study.type == "Before After"]       = df$SD_Before_impact[df$Study.type == "Before After"]
df$n1[df$Study.type == "Before After"]        = df$n_Before_impact[df$Study.type == "Before After"]

df$response2[df$Study.type == "Before After"] = df$Mean_After_impact[df$Study.type == "Before After"]
df$SD2[df$Study.type == "Before After"]       = df$SD_After_impact[df$Study.type == "Before After"]
df$n2[df$Study.type == "Before After"]        = df$n_After_impact[df$Study.type == "Before After"]

### Control Impact studies
df$response1[df$Study.type == "Control Impact"] = df$Mean_After_control[df$Study.type == "Control Impact"]
df$SD1[df$Study.type == "Control Impact"]       = df$SD_After_control[df$Study.type == "Control Impact"]
df$n1[df$Study.type == "Control Impact"]        = df$n_After_control[df$Study.type == "Control Impact"]

df$response2[df$Study.type == "Control Impact"] = df$Mean_After_impact[df$Study.type == "Control Impact"]
df$SD2[df$Study.type == "Control Impact"]       = df$SD_After_impact[df$Study.type == "Control Impact"]
df$n2[df$Study.type == "Control Impact"]        = df$n_After_impact[df$Study.type == "Control Impact"]

#### Before After Control Impact studies
df$AftCtrl_BefCtrl = df$Mean_After_control/df$Mean_Before_control
df$AftImpt_BefImpt = df$Mean_After_impact/df$Mean_Before_impact

df$SD1[df$Study.type == "Before After Control Impact"] = df$SD_After_control[df$Study.type == "Before After Control Impact"]
df$SD2[df$Study.type == "Before After Control Impact"] = df$SD_After_impact[df$Study.type == "Before After Control Impact"]

df$response1[df$Study.type == "Before After Control Impact"] = df$AftCtrl_BefCtrl[df$Study.type == "Before After Control Impact"]
df$response2[df$Study.type == "Before After Control Impact"] = df$AftImpt_BefImpt[df$Study.type == "Before After Control Impact"]

df$n1[df$Study.type == "Before After Control Impact"] = (df$n_After_control[df$Study.type == "Before After Control Impact"] 
                                                           + df$n_Before_control[df$Study.type == "Before After Control Impact"])/2
df$n2[df$Study.type == "Before After Control Impact"] = (df$n_After_impact[df$Study.type == "Before After Control Impact"] 
                                                           + df$n_Before_impact[df$Study.type == "Before After Control Impact"])/2

```

# Calculate lnRR and VlnRR

Log response ratio is calculated as (1) :
$ln(\overline{x}_{2}/\overline{x}_{1})$                                      (1), 
with $\overline{x}_{2}$ and $\overline{x}_{1})$ the means of the studied variable 
in the impact vs. control, or after vs. before samples respectively.

VarLnRR is calculated by first calculating the pooled standard deviation $S$ (2),
$S_{pooled} = \sqrt{\frac{(n_{1}-1)S^2_{1} + (n_{2}-1)S^2_{2}}{n_{1}+n_{2}-2}}$ (2)
and using $S$ to calculate the variance $V_{D}$ (3). See Borenstein et al., 2009
$V_{D} = \sqrt{\frac{S^2_{1}}{n_{1}} + \frac{S^2_{2}}{n_{2}}}$               (3)

No log response ratio is calculated where either of the responses is 0. This occurs 
only in cases where the mean response is 0, so when all observations are 0.
In the dataset, this only occurs when n = 1, so we lose several of these unique observations.
A possible work-around is to add a small value to the 0-observation, but this is 
arbitrary and the choice may have a large impact on the outcome of the ratio.

```{r calculate response ratio, warning=FALSE}

# Calculate lnRR
df$lnRR = log(df$response2/df$response1)

# Remove NaN log-responses (0/0 or log(-n))
df     <- df[-which(is.nan(df$lnRR)),] 

# Change Infinities to NA --> X/0 or 0/x
df$lnRR[df$lnRR == Inf]  = NA  # log(x/0)
df$lnRR[df$lnRR == -Inf] = NA  # log(0/x)

```

```{r }

# Pooled standard deviation
df$Spooled = sqrt(((df$n1 - 1) * (df$SD1^2) + (df$n2 - 1) * (df$SD2^2)) / (df$n1 + df$n2 - 2)) # Pooled within groups SD (S within or S pooled)

# VlnRR
# Where standard deviations are 0 I assign a 0 value to the eventual VarLnRR.
df$VarLnRR = df$Spooled^2 * ( 1 / (df$n1 * df$response1^2) + 1 / (df$n2 * df$response2^2))

## Before After Control Impact [BACI] VarlnRR 
df$VarLnRR[df$Study.type == "Before After Control Impact"] =
  df$SD_After_control[df$Study.type == "Before After Control Impact"]^2 / 
    (df$n_After_control[df$Study.type == "Before After Control Impact"] * 
       df$Mean_After_control[df$Study.type == "Before After Control Impact"]^2) +
  df$SD_Before_control[df$Study.type=="Before After Control Impact"]^2 / 
    (df$n_Before_control[df$Study.type=="Before After Control Impact"] * 
       df$Mean_Before_control[df$Study.type == "Before After Control Impact"]^2) + 
  df$SD_After_impact[df$Study.type == "Before After Control Impact"]^2 / 
    (df$n_After_impact[df$Study.type == "Before After Control Impact"] * 
       df$Mean_After_impact[df$Study.type == "Before After Control Impact"]^2) +
  df$SD_Before_impact[df$Study.type == "Before After Control Impact"]^2 /
    (df$n_Before_impact[df$Study.type == "Before After Control Impact"] * 
       df$Mean_Before_impact[df$Study.type == "Before After Control Impact"]^2)

df$VarLnRR[is.nan(df$VarLnRR)] <- 0
df$SE=sqrt(df$VarLnRR)

# Weight (W) for lnRR effect size
df$W              = 1 / df$VarLnRR

# Set minimum weights to 0.1. 35 observations are below this value naturally,
# Infinity's are also set to this value. I do not want to assign a 0 value to these
# observations.
# There are several very influental observations. I don't know how to feel about these.
df$W[df$W < 0.1]  = 0.1
df$W[df$W == Inf] = 0.1  
df$WY             = df$W * df$lnRR   # Effect size multiplied by weight
df$WY2            = df$W * df$lnRR^2 # W * Y^2
df$WYsquared      = df$WY^2

```

## Calculation of Cohens d and derived HEdges g.

- Produces NA's and leaves less rows.    

```{r cohen's d calculation}
 
# Cohen's d calculations (Standardized mean difference)
# variance calculated with escalc
# Add 0.1 to all SD's to prevent NA issues etc.
df <- escalc(measure = "SMD", m1i = response2, m2i = response1, sd1i = SD2, 
             sd2i = SD1, n1i = n2, n2i = n1, data = df, var.names = c("d","Vd"), digits = 4,
             add = 0.1, to = "all") 
df$SEd        = sqrt(df$Vd)
df$Wd         = 1 / df$Vd             # Weight for Cohen's d fixed effects
df$Wd[df$Wd == Inf] = NA  
df$WYd        = df$Wd * df$d         # Cohen's d multiplied by weight
df$WYd2       = df$Wd * df$d^2  # W * Y^2
df$WYdsquared = df$WYd^2

#Convert to hedges g
df$g = df$d * (1 - (3 / 4 * (df$n1 + df$n2 - 2) - 1))
df$Vg = 1 - (3 / 4 * (df$n1 + df$n2 - 2) - 1) * df$Vd
df$SEg = sqrt(df$Vg)
df$Wg = 1 / df$Vg             # Weight for Hedges g fixed effects
df$Wg[df$Wg == Inf] = NA  
df$WYg = df$Wg*df$g         # Hedges g multiplied by weight
df$WYg2 = df$Wg * df$g ^ 2  # W * Y^2
df$WYgsquared = df$WYg^2

# save stuff 
save(file = "../r_objects/Exp-Obs_041122.rda", df)

```

